{
    "TX_NEW": "SELECT p.PatientID, p.sex, p.DateOfBirth,(CAST(strftime('%Y', 'now') AS INTEGER) - CAST(strftime('%Y', p.DateOfBirth) AS INTEGER)) AS AGE,p.dateconfirmedHIVPositive, v.VisitDate, v.ARVStatusCode, p.ReferredFromID AS 'TESTING POINT',v.NowPregnant, v.NowBreastFeeding FROM tblPatients p JOIN tblVisits v ON p.PatientID = v.PatientID WHERE v.ARVStatusCode IN (2) GROUP BY p.PatientID, p.sex, p.DateOfBirth, v.VisitDate, p.ReferredFromID,p.dateconfirmedHIVPositive, v.NowPregnant, v.NowBreastFeeding, v.ARVStatusCode HAVING MIN(v.VisitDate) BETWEEN :STARTDATE AND :ENDDATE ORDER BY p.PatientID",
    "HTS_TST": "SELECT c.visitDate, c.ClientCode AS 'TESTING ID', (CAST(strftime('%Y', 'now') AS INTEGER) - CAST(strftime('%Y', c.DateOfBirth) AS INTEGER)) AS Age, c.AttendanceCode AS 'TYPE OF CLIENT', c.SexCode AS 'SEX', c.ReferredFromCode, c.PregnancyStatusCode AS 'PMTCT STATUS', c.HIVResultCode AS 'HIV Result', c.visitType AS 'Testing Modality', c.ClientType AS 'Source of Testing', c.TestingType AS 'Testing Type', c.EQA, c.Remarks, c.CondomsIssuedFemale, c.CondomsIssuedMale FROM tblCT c WHERE c.visitDate BETWEEN :STARTDATE AND :ENDDATE AND c.TestingType NOT IN ('UU', 'ST') AND c.TypeOfSampleID IN (1) AND (c.visitType IN ('PITC','CBHTS','All') OR (c.visitType IN ('CITC') AND c.HIVResultCode IN ('CH'))) GROUP BY c.ClientCode, c.DateOfBirth, c.AttendanceCode, c.SexCode, c.ReferredFromCode, c.PregnancyStatusCode, c.HIVResultCode, c.visitType, c.ClientType, c.TestingType, c.EQA, c.Remarks, c.CondomsIssuedFemale, c.CondomsIssuedMale, c.visitDate ORDER BY c.ClientCode",
    "HTS_SELF": "SELECT c.visitDate, c.ClientCode AS 'Testing ID', CAST(strftime('%Y', 'now') AS INTEGER) - CAST(strftime('%Y', c.DateOfBirth) AS INTEGER) - (strftime('%m-%d', 'now') < strftime('%m-%d', c.DateOfBirth)) AS Age, c.AttendanceCode AS 'Type of Clients', c.SexCode AS 'SEX', c.ReferredFromCode, c.PregnancyStatusCode AS 'PMTCT STATUS', CASE c.PregnancyStatusCode WHEN 'MO' THEN 'New Pregnant' WHEN 'SM' THEN 'Not Pregnant' WHEN 'HA' THEN 'Not Sure on Pregnancy' WHEN 'HH' THEN 'Not Applicable' WHEN 'BF' THEN 'Breast Feeding' ELSE NULL END AS 'Pregnancy Status', c.HIVResultCode AS 'HIV Result', c.visitType AS 'Testing Modality', c.ClientType AS 'Source of Testing', c.TestingType AS 'Testing Type', c.CounsellingTypeCode AS 'Kit Modal of Distribution', c.Remarks, c.SelfTestSelfKitName AS 'Self Kit Distributed', c.SelfTestPartnerKitName AS 'Partner Kit Distributed', c.SelfTestFriendKitName AS 'Peer Kit Distributed', c.SelfTestingResults AS 'Self Kit Result', c.SelfTestingResultsPartner AS 'Parter Kit Result', c.SelfTestingResultsFriend AS 'Friend Kit Result', CASE c.ReferredFromCode WHEN 'KK' THEN 'TB Unit' WHEN 'ONST' THEN 'Onsite Self Testing' WHEN 'IM' THEN 'OPD Unit' WHEN 'WW' THEN 'IPD Unit' WHEN 'WE' THEN 'CITC Unit' WHEN 'UM' THEN 'Family Planing Unit' WHEN 'HT' THEN 'CTC Unit' WHEN 'TW' THEN 'VMMC Unit' WHEN 'OS' THEN 'Outreach Service Unit' WHEN 'RCH' THEN 'PMTCT Unit' WHEN 'MB' THEN 'Lab Unit' WHEN 'US' THEN 'CECAP Unit' WHEN 'OFST' THEN 'Offsite Self Testing' WHEN 'HW' THEN 'Mobile Testing' ELSE NULL END AS 'Testing Points' FROM tblCT c WHERE c.TestingType IN ('ST') AND date(c.visitDate) BETWEEN date(:STARTDATE) AND date(:ENDDATE) GROUP BY c.ClientCode, c.DateOfBirth, c.AttendanceCode, c.SexCode, c.ReferredFromCode, c.PregnancyStatusCode, c.HIVResultCode, c.SelfTestSelfKitName, c.SelfTestPartnerKitName, c.SelfTestFriendKitName, c.SelfTestingResults, c.SelfTestingResultsPartner, c.SelfTestingResultsFriend, c.visitType, c.ClientType, c.TestingType, c.CounsellingTypeCode, c.Remarks, c.visitDate ORDER BY c.ClientCode",
    "HTS_INDEX_ELICITATION": "WITH lastVdate AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE VisitDate <= :ENDDATE GROUP BY PatientID), Visited6Months AS (SELECT v.PatientID, v.VisitDate, v.NumDaysDispensed FROM tblVisits v JOIN lastVdate lv ON lv.PatientID = v.PatientID WHERE v.VisitDate = lv.maxVdate AND v.VisitDate <= :ENDDATE GROUP BY v.PatientID, v.VisitDate, v.NumDaysDispensed), FamInfo AS (SELECT DISTINCT f.PatientID, f.RelativeType, f.RelativeAtThisClinic, f.RelativeCTCID, f.RelativeID, f.DateConfirmedHIVPositive, f.RowVersion FROM tblFamilyInfo f), RelativeInfo AS (SELECT DISTINCT r.RelativeID, r.RelativeAge, r.RelativeHIVStatus, r.RelativeStatus, r.DateConfirmedHIVPositive AS 'Relative Date Confirmed HIV Positive' FROM tblFamilyRelatives r), TX_CURR AS (SELECT v.PatientID, v.VisitDate, v.NumDaysDispensed, MAX(a.DateAppointmentGiven) AS DateAppointmentGiven, MAX(a.DateOfAppointment) AS DateOfAppointment FROM tblVisits v JOIN lastVdate lv ON lv.PatientID = v.PatientID LEFT JOIN tblAppointments a ON a.PatientID = v.PatientID WHERE v.VisitDate = lv.maxVdate AND v.VisitDate <= :ENDDATE AND ((julianday(:ENDDATE) - julianday(date(v.VisitDate, printf('+%d days', COALESCE(v.NumDaysDispensed,0))))) < 30 OR (julianday(:ENDDATE) - julianday(a.DateOfAppointment)) < 30) GROUP BY v.PatientID, v.VisitDate, v.NumDaysDispensed), LastStatusDate AS (SELECT s.PatientID, s.StatusDate, s.Status FROM tblStatus s JOIN (SELECT PatientID, MAX(StatusDate) AS maxSdate FROM tblStatus GROUP BY PatientID) t ON t.PatientID = s.PatientID AND s.StatusDate = t.maxSdate), NextDateOfAppointment AS (SELECT a.PatientID, a.DateAppointmentGiven, a.DateOfAppointment, a.Cancelled, a.Notes FROM tblAppointments a JOIN (SELECT PatientID, MAX(DateOfAppointment) AS maxAdate FROM tblAppointments GROUP BY PatientID) t ON t.PatientID = a.PatientID AND a.DateOfAppointment = t.maxAdate), Elicitation AS (SELECT DISTINCT e.PatientID, e.TestingPoint, e.IndexElicitationID, e.DateOfElicitation, e.ContantsElicitationsStatusDate FROM tblIndexElicitations e), ContactElicited AS (SELECT c.IndexElicitationID, c.IndexContactSex, c.IndexContactDoB, ((strftime('%Y', :ENDDATE) - strftime('%Y', c.IndexContactDoB)) - (strftime('%m-%d', :ENDDATE) < strftime('%m-%d', c.IndexContactDoB))) AS 'Index Contact Age', c.RelationshipToIndexClient, c.IPVScreening, c.IPVScreeningOutcome, c.IndexContactRefDate, c.DateReached, c.DateTested, c.FinalTestResults, c.HIVStatusCode, c.IndexClientPatientID, c.Comments FROM tblIndexElicitationContacts c) SELECT Visited6Months.PatientID AS 'Index Unique ID', CASE WHEN (julianday(:ENDDATE) - julianday(LastStatusDate.StatusDate)) >= 30 AND LastStatusDate.Status = 'Transferred to another clinic' THEN 'NO' WHEN LastStatusDate.Status IN ('Died','Opted out','Lost to follow-up','Not HIV positive') THEN 'NO' WHEN ((julianday(:ENDDATE) - julianday(date(Visited6Months.VisitDate, printf('+%d days', COALESCE(Visited6Months.NumDaysDispensed,0))))) < 30 OR COALESCE(julianday(:ENDDATE) - julianday(NextDateOfAppointment.DateOfAppointment), 9999) < 30) AND LastStatusDate.Status IN ('Transferred to another clinic','Attending this clinic','Confirmed HIV positive') THEN 'YES' WHEN ((julianday(:ENDDATE) - julianday(date(Visited6Months.VisitDate, printf('+%d days', COALESCE(Visited6Months.NumDaysDispensed,0))))) >= 30 OR COALESCE(julianday(:ENDDATE) - julianday(NextDateOfAppointment.DateOfAppointment), 9999) >= 30) AND LastStatusDate.Status IN ('Attending this clinic','Missing appointments') THEN 'NO' WHEN ((julianday(:ENDDATE) - julianday(date(Visited6Months.VisitDate, printf('+%d days', COALESCE(Visited6Months.NumDaysDispensed,0))))) < 30 OR COALESCE(julianday(:ENDDATE) - julianday(NextDateOfAppointment.DateOfAppointment), 9999) < 30) AND LastStatusDate.Status = 'Missing appointments' THEN 'YES' ELSE NULL END AS 'TX_CURR?', Visited6Months.VisitDate AS 'Index Last Visit Date', Visited6Months.NumDaysDispensed AS 'Index Last numDaysDispensed', FamInfo.RelativeType, FamInfo.RelativeAtThisClinic, FamInfo.RelativeCTCID, RelativeInfo.RelativeAge, RelativeInfo.RelativeHIVStatus, RelativeInfo.RelativeStatus, FamInfo.DateConfirmedHIVPositive AS 'Date Relative Confirmed HIV Positive', TX_CURR.DateAppointmentGiven AS 'Index DateAppointmentGiven', TX_CURR.DateOfAppointment AS 'Index Next Appointment Date', CASE WHEN NextDateOfAppointment.DateOfAppointment IS NOT NULL AND COALESCE(NextDateOfAppointment.Cancelled, 0) >= 0 THEN 'Active Appointment' WHEN NextDateOfAppointment.DateOfAppointment IS NOT NULL AND COALESCE(NextDateOfAppointment.Cancelled, 0) < 0 THEN 'Cancelled Appointment' ELSE NULL END AS 'Index Appointment Status', NextDateOfAppointment.Notes AS 'Index Appointment Notes', LastStatusDate.StatusDate AS 'Index Last Status Date', LastStatusDate.Status AS 'Index Last Status', Elicitation.DateOfElicitation, Elicitation.TestingPoint, Elicitation.ContantsElicitationsStatusDate, ContactElicited.IndexContactSex, ContactElicited.'Index Contact Age', ContactElicited.RelationshipToIndexClient, ContactElicited.IPVScreening, ContactElicited.IPVScreeningOutcome, ContactElicited.IndexContactRefDate, ContactElicited.DateReached, ContactElicited.DateTested, ContactElicited.FinalTestResults, ContactElicited.HIVStatusCode, ContactElicited.Comments, ContactElicited.IndexClientPatientID FROM Visited6Months LEFT JOIN tblPatients ON tblPatients.PatientID = Visited6Months.PatientID LEFT JOIN FamInfo ON FamInfo.PatientID = Visited6Months.PatientID LEFT JOIN RelativeInfo ON RelativeInfo.RelativeID = FamInfo.RelativeID LEFT JOIN TX_CURR ON TX_CURR.PatientID = Visited6Months.PatientID LEFT JOIN LastStatusDate ON LastStatusDate.PatientID = Visited6Months.PatientID LEFT JOIN NextDateOfAppointment ON NextDateOfAppointment.PatientID = Visited6Months.PatientID LEFT JOIN Elicitation ON Elicitation.PatientID = Visited6Months.PatientID LEFT JOIN ContactElicited ON ContactElicited.IndexElicitationID = Elicitation.IndexElicitationID WHERE Elicitation.ContantsElicitationsStatusDate BETWEEN :STARTDATE AND :ENDDATE",
    "TX_NEW_INDEX_CONTACTS": "SELECT ic.*, CAST((julianday('now') - julianday(ic.IndexContactDoB)) / 365.25 AS INT) AS Age FROM tblIndexElicitationContacts ic JOIN tblIndexElicitations ie ON ic.IndexElicitationID = ie.IndexElicitationID JOIN tblPatients p ON ie.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = p.PatientID WHERE v.ARVStatusCode = 2 AND v.VisitDate BETWEEN :STARTDATE AND :ENDDATE",
    "TX_CURR": "WITH last_visit AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE ARVStatusCode IN (3,6,8,9,10) AND VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY PatientID) SELECT p.PatientID, p.Sex, p.DateOfBirth, ((strftime('%Y','now') - strftime('%Y',p.DateOfBirth)) - (strftime('%m-%d','now') < strftime('%m-%d',p.DateOfBirth))) AS Age, p.DateConfirmedHIVPositive, v.VisitDate, v.ARVStatusCode, p.ReferredFromID AS 'TESTING POINT', v.NowPregnant, v.NowBreastFeeding FROM tblPatients p JOIN last_visit lv ON lv.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = lv.PatientID AND v.VisitDate = lv.maxVdate ORDER BY p.PatientID",
    "TX_CURR_HVL_OFFERED_ACCEPTED": "WITH last_visit AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE ARVStatusCode IN (3,6,8,9,10) AND VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY PatientID), latest_hvl AS (SELECT t.* FROM tblTests t JOIN (SELECT PatientID, MAX(TestDate) AS maxT FROM tblTests WHERE CAST(ResultNumeric AS REAL) >= 1000 GROUP BY PatientID) mx ON mx.PatientID = t.PatientID AND t.TestDate = mx.maxT WHERE CAST(t.ResultNumeric AS REAL) >= 1000), latest_appt AS (SELECT a.* FROM tblAppointments a JOIN (SELECT PatientID, MAX(DateOfAppointment) AS maxA FROM tblAppointments GROUP BY PatientID) m ON m.PatientID = a.PatientID AND a.DateOfAppointment = m.maxA) SELECT p.PatientID, p.sex, p.DateOfBirth, ((strftime('%Y','now') - strftime('%Y',p.DateOfBirth)) - (strftime('%m-%d','now') < strftime('%m-%d',p.DateOfBirth))) AS AGE, p.DateConfirmedHIVPositive, v.VisitDate, v.ARVStatusCode, p.ReferredFromID AS 'TESTING POINT', v.NowPregnant, v.NowBreastFeeding, th.ResultNumeric FROM tblPatients p JOIN last_visit lv ON lv.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = p.PatientID AND v.VisitDate = lv.maxVdate JOIN latest_hvl th ON th.PatientID = p.PatientID JOIN latest_appt la ON la.PatientID = p.PatientID WHERE la.DateOfAppointment IS NOT NULL AND la.DateAppointmentGiven IS NOT NULL AND la.DateOfAppointment <= date(la.DateAppointmentGiven, '+6 months') ORDER BY p.PatientID",
    "TX_CURR_HVL_CONTACTS": "WITH last_visit AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE ARVStatusCode IN (3,6,8,9,10) AND VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY PatientID), latest_hvl AS (SELECT t.* FROM tblTests t JOIN (SELECT PatientID, MAX(TestDate) AS maxT FROM tblTests WHERE CAST(ResultNumeric AS REAL) >= 1000 GROUP BY PatientID) mx ON mx.PatientID = t.PatientID AND t.TestDate = mx.maxT WHERE CAST(t.ResultNumeric AS REAL) >= 1000), latest_appt AS (SELECT a.* FROM tblAppointments a JOIN (SELECT PatientID, MAX(DateOfAppointment) AS maxA FROM tblAppointments GROUP BY PatientID) m ON m.PatientID = a.PatientID AND a.DateOfAppointment = m.maxA) SELECT c.*, ((strftime('%Y','now') - strftime('%Y',c.IndexContactDoB)) - (strftime('%m-%d','now') < strftime('%m-%d',c.IndexContactDoB))) AS Age FROM tblIndexElicitationContacts c JOIN tblIndexElicitations ie ON c.IndexElicitationID = ie.IndexElicitationID JOIN tblPatients p ON ie.PatientID = p.PatientID JOIN last_visit lv ON lv.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = p.PatientID AND v.VisitDate = lv.maxVdate JOIN latest_hvl th ON th.PatientID = p.PatientID JOIN latest_appt la ON la.PatientID = p.PatientID WHERE la.DateOfAppointment IS NOT NULL AND la.DateAppointmentGiven IS NOT NULL AND la.DateOfAppointment <= date(la.DateAppointmentGiven, '+6 months') ORDER BY p.PatientID",
    "TX_CURR_HVL_OTHER": "WITH last_visit AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE ARVStatusCode IN (3,6,8,9,10) AND VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY PatientID), latest_hvl AS (SELECT t.* FROM tblTests t JOIN (SELECT PatientID, MAX(TestDate) AS maxT FROM tblTests WHERE CAST(ResultNumeric AS REAL) < 1000 GROUP BY PatientID) mx ON mx.PatientID = t.PatientID AND t.TestDate = mx.maxT WHERE CAST(t.ResultNumeric AS REAL) < 1000), latest_appt AS (SELECT a.* FROM tblAppointments a JOIN (SELECT PatientID, MAX(DateOfAppointment) AS maxA FROM tblAppointments GROUP BY PatientID) m ON m.PatientID = a.PatientID AND a.DateOfAppointment = m.maxA) SELECT p.PatientID, p.sex, p.DateOfBirth, ((strftime('%Y','now') - strftime('%Y',p.DateOfBirth)) - (strftime('%m-%d','now') < strftime('%m-%d',p.DateOfBirth))) AS AGE, p.DateConfirmedHIVPositive, v.VisitDate, v.ARVStatusCode, p.ReferredFromID AS 'TESTING POINT', v.NowPregnant, v.NowBreastFeeding, th.ResultNumeric FROM tblPatients p JOIN last_visit lv ON lv.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = p.PatientID AND v.VisitDate = lv.maxVdate JOIN latest_hvl th ON th.PatientID = p.PatientID JOIN latest_appt la ON la.PatientID = p.PatientID WHERE la.DateOfAppointment IS NOT NULL AND la.DateAppointmentGiven IS NOT NULL AND la.DateOfAppointment <= date(la.DateAppointmentGiven, '+6 months') ORDER BY p.PatientID",
    "TX_CURR_HVL_OTHER_CONTACTS": "WITH last_visit AS (SELECT PatientID, MAX(VisitDate) AS maxVdate FROM tblVisits WHERE ARVStatusCode IN (3,6,8,9,10) AND VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY PatientID), latest_hvl AS (SELECT t.* FROM tblTests t JOIN (SELECT PatientID, MAX(TestDate) AS maxT FROM tblTests WHERE CAST(ResultNumeric AS REAL) < 1000 GROUP BY PatientID) mx ON mx.PatientID = t.PatientID AND t.TestDate = mx.maxT WHERE CAST(t.ResultNumeric AS REAL) < 1000), latest_appt AS (SELECT a.* FROM tblAppointments a JOIN (SELECT PatientID, MAX(DateOfAppointment) AS maxA FROM tblAppointments GROUP BY PatientID) m ON m.PatientID = a.PatientID AND a.DateOfAppointment = m.maxA) SELECT c.*, ((strftime('%Y','now') - strftime('%Y',c.IndexContactDoB)) - (strftime('%m-%d','now') < strftime('%m-%d',c.IndexContactDoB))) AS Age FROM tblIndexElicitationContacts c JOIN tblIndexElicitations ie ON c.IndexElicitationID = ie.IndexElicitationID JOIN tblPatients p ON ie.PatientID = p.PatientID JOIN last_visit lv ON lv.PatientID = p.PatientID JOIN tblVisits v ON v.PatientID = p.PatientID AND v.VisitDate = lv.maxVdate JOIN latest_hvl th ON th.PatientID = p.PatientID JOIN latest_appt la ON la.PatientID = p.PatientID WHERE la.DateOfAppointment IS NOT NULL AND la.DateAppointmentGiven IS NOT NULL AND la.DateOfAppointment <= date(la.DateAppointmentGiven, '+6 months') ORDER BY p.PatientID",
    "TX_RTT": "WITH last_before AS (SELECT v.PatientID, MAX(v.VisitDate) AS lastBefore FROM tblVisits v WHERE v.VisitDate < :STARTDATE GROUP BY v.PatientID), last_status_before AS (SELECT s.PatientID, s.Status, s.StatusDate FROM tblStatus s JOIN (SELECT PatientID, MAX(StatusDate) AS maxS FROM tblStatus WHERE StatusDate < :STARTDATE GROUP BY PatientID) mx ON mx.PatientID = s.PatientID AND s.StatusDate = mx.maxS WHERE s.Status IN ('Lost to follow-up','IIT','Missing appointments')), restart_in_period AS (SELECT v.PatientID, MIN(v.VisitDate) AS restartDate FROM tblVisits v WHERE v.VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY v.PatientID) SELECT p.PatientID, p.hfr_code, p.Sex AS PatientSex, CAST((julianday(r.restartDate) - julianday(p.DateOfBirth)) / 365.25 AS INT) AS PatientAge, CAST(julianday(r.restartDate) - julianday(lsb.StatusDate) AS INT) AS DaysOutOfCare, v.VisitDate, v.ARVStatusCode FROM restart_in_period r JOIN last_status_before lsb ON r.PatientID = lsb.PatientID JOIN last_before lb ON lb.PatientID = r.PatientID JOIN tblPatients p ON p.PatientID = r.PatientID JOIN tblVisits v ON v.PatientID = r.PatientID AND v.VisitDate = r.restartDate WHERE julianday(r.restartDate) - julianday(lb.lastBefore) > 28 ORDER BY p.PatientID",
    "TX_RTT_CONT_OFF_ACC": "WITH last_before AS (SELECT v.PatientID, MAX(v.VisitDate) AS lastBefore FROM tblVisits v WHERE v.VisitDate < :STARTDATE GROUP BY v.PatientID), last_status_before AS (SELECT s.PatientID, s.Status FROM tblStatus s JOIN (SELECT PatientID, MAX(StatusDate) AS maxS FROM tblStatus WHERE StatusDate < :STARTDATE GROUP BY PatientID) mx ON mx.PatientID = s.PatientID AND s.StatusDate = mx.maxS WHERE s.Status IN ('Lost to follow-up','IIT','Missing appointments')), restart_in_period AS (SELECT v.PatientID, MIN(v.VisitDate) AS restartDate FROM tblVisits v WHERE v.VisitDate BETWEEN :STARTDATE AND :ENDDATE GROUP BY v.PatientID) SELECT p.PatientID, p.hfr_code, p.Sex AS PatientSex, CAST((julianday(r.restartDate) - julianday(p.DateOfBirth)) / 365.25 AS INT) AS PatientAge, ic.IndexContactSex AS ContactSex, CAST((julianday(r.restartDate) - julianday(ic.IndexContactDoB)) / 365.25 AS INT) AS ContactAge, ic.Comments,ic.FinalTestResults, ic.IndexContactRefDate, ic.DateTested, v.VisitDate, v.ARVStatusCode FROM restart_in_period r JOIN last_status_before lsb ON r.PatientID = lsb.PatientID JOIN last_before lb ON lb.PatientID = r.PatientID JOIN tblPatients p ON p.PatientID = r.PatientID JOIN tblVisits v ON v.PatientID = r.PatientID AND v.VisitDate = r.restartDate LEFT JOIN tblIndexElicitations ie ON ie.PatientID = p.PatientID LEFT JOIN tblIndexElicitationContacts ic ON ic.IndexElicitationID = ie.IndexElicitationID WHERE julianday(r.restartDate) - julianday(lb.lastBefore) > 28 ORDER BY p.PatientID"
}